# 恶意代码

## 恶意代码定义

**恶意代码** 是指攻击这为某种目的和利益而设计的独立、可执行文件或者一段非独立的二进制代码。可以在未经系统用户允许和管理员授权的 情况下，对计算机、服务器、客户端甚至计算机网络造成严重损害。

常见的有：计算机病毒、特洛伊木马、蠕虫、Backdoor、僵尸网络...

## 恶意代码命名规则

![image-20210622163838269](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210622163838269.png)

Platform 表示恶意代码能够运行的系统环境；

family_name 表示恶意代码的家族名称； 

group_name 代表计算机病毒族；

infective_length 表示用病毒感染长度区分 family 或 group 中不同寄生病毒标记

现如今，杀毒软件厂商为了方便管理，大体采用统一的恶意代码命名格式为： <恶意代码前缀>.<恶意代码名称>.<恶意代码后缀>

![image-20210622164811760](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210622164811760.png)

## 恶意代码分类

恶意代码从**独立性**和**自我复制性**的角度进行分类，独立的恶意代码拥有完整程序的 所有功能，可以自我复制而不需要寄宿在另一个程序中。非独立的恶意代码指的是一段代码在单独情况下无法自我复制，必须借助其他媒介进行传播，便可以正常运行。

分为：**计算机病毒、特洛伊木马、蠕虫、Backdoor、僵尸网络**

* 计算机病毒：

  计算机病毒是不法分子利用计算机软、硬件上的缺陷和漏洞编写的一 段可执行代码或者一个可运行程序。其传播速度快，并且难以根除，具有极大的破坏性。

  *划分成引导区型、文件型和混合型三种类型。*

  *引导型病毒感染软盘中的引导区，并感染用户盘中的主引导记录。磁盘引导区病毒主要 用病毒的全部或部分逻辑取代正常的引导记录，在运行的一开始便获得控制权。文件型 病毒是文件感染者，它运行在计算机存储器里，把自身复制到其他文件中，并在特定条 件下进行表现或破坏。*

  *混合型病毒兼具两者的特点、危害更大、清除难度也更大。*

* 特洛伊木马

  表面有用实际却危害计算机的应用程序。特洛 伊木马以电子邮件的形式，或者通过绑定非法网站中的软件来达到传播目的，其**本身不具有传染性。**包含服务端和控制端，木马的服务端在运行后会产生一个迷 惑用户的进程，通过暗中打开端口，从而向指定地点发送数据，不法分子甚至可以利用这些打开的端口进入电脑系统。

* 计算机蠕虫

  蠕虫病毒是一种完全独立且能够自我复制的计算机程序，它利用操作 系统或已安装程序中的漏洞，依附于 MIRC 和 htm 文件，在网络中主动传播。

  *如果计算机感染了蠕虫，会直接 运行计算机驱动器，搜索可以感染的软件实现传播，蠕虫代码覆盖原文件，并更改文件 的扩展名为 vbs。蠕虫在网络上传播速度非常快，这使得它们成为最难拦截的恶意程序 之一。蠕虫可潜入用户的系统并自动通过电子邮件向其他人发送自己的副本，占用计算 机资源，影响电脑运行速度，导致用户计算机系统崩溃。*

  *它还具有一些特性，如不不需 要寄生在主机文件，对网络造成拒绝服务等等。蠕虫病毒的传播方式是多种多样的。例 如，“红色代码”可以驻留在计算机内存中，利用操作系统的漏洞主动进行攻击。“爱 虫病毒”和“求职信病毒”等病毒会通过电子邮件、恶意网页的形式迅速传播*

* Backdoor

  后门是一种绕过安全控制来访问程序或系统的程序方法。后门由特定的 用户以特定的方式进行控制。在大多数服务器内，端口绑定技术允许攻击者配置一个后门，以便与特定的服务器端口直接通信或“绑定”，从而更容易控制受影响的服务器。 一旦建立连接之后，后门就可以生成一个简单的 shell 来执行命令。

* 僵尸网络

  僵尸程序是一种智能恶意代码，它综合了木马、蠕虫和其他技术。僵尸 程序使用各种方法秘密地植入一个受害主机，并基于远程命令发起恶意行为。

  *僵尸网络 是一组受感染的主机，其中包括一台充当服务器的僵尸网络控制器和一组由攻击者远程控制的计算机。为了让僵尸网络控制器命令僵尸计算机，需要一个 C&C 控制通道，僵 尸计算机通过它接受命令、协调攻击和欺诈活动。集中的 C&C 结构使用互联网中继聊 天 IRC 协议，在这种架构中，每个将是计算机都登录到一个 IRC 通道，并从僵尸网络 控制器那里获取命令。现在相当多的僵尸网络已经开始使用其他协议，比如 HTTP 协议， 这是因为基于 HTTP 协议的 C&C 通信更隐蔽，并且大多数网络允许 Web 流量。僵尸网 络会被攻击者利用作为攻击的资源或平台，如分布式拒绝服务攻击，以及欺诈活动，如 垃圾邮件、网络钓鱼、身份盗窃和信息泄露*

## 恶意代码基本特性

非法性、隐藏性、潜伏性、可触发性、破坏性、传染性

**非法性**。恶意代码具有非法性，它会在合法程序中附着。当合法程序被正常运行时， 恶意代码不会马上表现出来，因此用户无法察觉到系统异常。恶意代码会等待适宜时机 来窃取系统的控制权。恶意代码具有正常程序的特性，但它对系统的操作都是违背用户 意愿的，因此恶意代码具有非法性。 

**隐藏性**。个人电脑每秒可以访问超过几百千字节的 DOS 文件，而恶意代码是一种 只有几百字节或者几千字节的可执行文件，因此恶意代码可以在很短的时间内将自己添 加到正常的程序中。恶意代码可能隐藏在磁盘扇区中，以隐藏文件的形式出现，甚至可 能被放置在 Windows 系统目录中，并以类似 Windows 系统文件的方式命名。 

**潜伏性**。恶意代码可以附加到其他传播媒介，并感染正常的程序和系统；它不会立 即表现出来，也不会引起计算机用户的注意。恶意代码在系统潜伏的时间愈长，感染范 围越大，危害性也就愈高。只有在满足某些条件或者触发某些功能时，恶意代码才会启 动。 

**可触发性**。恶意代码有一个或者多个触发条件，在满足一定条件控制（如输入特定 字符、使用属性文件、命中特定日期或命中计数器特定次数等）时，就会触发感染机制。 

**破坏性。**恶意代码会破坏系统的硬件和软件，在严重的情况下会使整个系统无法正 常运行。恶意代码会占用大量内存空间、网络流量、破坏文件甚至破坏计算机硬件。例 如，“Happy Time”病毒采用 VBScript 语言编写，可以通过电子邮件形式进行传播。 “欢乐病毒”的发作条件是计算机时钟的日期和月份之和为 13，当满足这一触发条件

**传染性**。传染性可以判断一段代码是否是恶意的。破坏计算机系统的恶意代码通过 自我复制迅速传播。恶意代码可以在程序之间，网络之间，计算机之间进行感染、传播。 蠕虫被认为是传播最快和最广泛的。目前，利用电子邮件快捷方便的特点，恶意代码将 通过电子邮件传播



## 恶意代码分析基础

恶意代码分信息目的：

* 特征码
* 分析报告
* 专杀工具

![image-20210625130757861](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210625130757861.png)

C2：僵尸网络控制端

![image-20210625131002972](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210625131002972.png)

下载器+启动器，是一个闭环。现在的恶意代码是多模块配合。

间谍软件：偷取信息。

内核套件：比较底层，权限相对较高，不容易被发现。

CPU：第三环，应用层；零环，驱动层；一二层使用较少。

勒索软件：对别人电脑中的重要软件作非对称加密。要求钱财。

蠕虫：带感染功能的，都叫蠕虫。



## 恶意软件样本库

*收集用于分析的恶意软件样本*

- [Clean MX](https://link.zhihu.com/?target=http%3A//support.clean-mx.de/clean-mx/viruses.php) - 恶意软件和恶意域名的实时数据库
- [Contagio](https://link.zhihu.com/?target=http%3A//contagiodump.blogspot.com/) - 近期的恶意软件样本和分析的收集
- [Exploit Database](https://link.zhihu.com/?target=https%3A//www.exploit-db.com/) - Exploit 和 shellcode 样本
- [Malshare](https://link.zhihu.com/?target=http%3A//malshare.com/) - 在恶意网站上得到的大量恶意样本库
- [MalwareDB](https://link.zhihu.com/?target=http%3A//malwaredb.malekal.com/) - 恶意软件样本库
- [Open Malware Project](https://link.zhihu.com/?target=http%3A//openmalware.org/) - 样本信息和下载
- [Ragpicker](https://link.zhihu.com/?target=https%3A//github.com/robbyFux/Ragpicker) - 基于 malware crawler 的一个插件
- [theZoo](https://link.zhihu.com/?target=https%3A//github.com/ytisf/theZoo) - 分析人员的实时恶意样本库
- [Tracker h3x](https://link.zhihu.com/?target=http%3A//tracker.h3x.eu/) - Agregator 的恶意软件跟踪和下载地址
- [ViruSign](https://link.zhihu.com/?target=http%3A//www.virusign.com/) - 除 ClamAV 外的反病毒程序检出的恶意软件数据库
- [VirusShare](https://link.zhihu.com/?target=http%3A//virusshare.com/) - 恶意软件库
- [VX Vault](https://link.zhihu.com/?target=http%3A//vxvault.net/) - 恶意软件样本的主动收集
- [Zeltser's Sources](https://link.zhihu.com/?target=https%3A//zeltser.com/malware-sample-sources/) - 由 Lenny Zeltser 整理的恶意软件样本源列表
- [Zeus Source Code](https://link.zhihu.com/?target=https%3A//github.com/Visgean/Zeus) - 2011 年 Zeus 源码泄露



## 恶意代码分析方法

* **静态分析**

基础技术

主要是特征码扫描，该技术利用简单的特征码来判断文件是否存在恶意。对复杂的恶意代码基本无效，可能会遗漏一些行为。

高级技术

主要是静态启发式扫描技术，将可执行文件放到反汇编器里，将二进制文件转换成汇编语言。查看程序指令来判断。



* **动态分析**

主要检测：文件行为、进程行为、网络行为、注册表行为

基础：沙箱，用安全的环境来运行恶意代码。轻量级虚拟机。代码对文件和注册表的操作为重定向到指定位置。

高级：动态行为分析，提供执行文件中抽取信息的路径，通过调试器跟踪观察程序的内部状态（寄存器内容、函数结果、内存使用...）。

动态分析方法可以有效提高分析的准确率，动态行为分析技术能够有效地弥补传统 的特征码检测技术无法检测到未知病毒的缺点。但是该技术也存在着不足，如产生的误 报率较高，且不能识别出病毒的名称和类型。



# 基于API调用的恶意代码动态行为分析

## Cuckoo HOOK技术

Cuckoo Sandbox中Host Machine（中央关系模块）负责动态行为监控以及HOOK函数设置。

API Hook对虚拟机中的API函数设置钩子，获取API调用的行为，将函数地址改到调用函数的指针上。调用函数时就能调用事先编写好的函数，避免攻击，同时可以透明观察函数对虚拟机的内部调用。

* 文件操作：会跳转自己写好的函数中，不让其直接调用系统函数。（如创建文件“CreateFile”函数会调转到“myCreateFIle”）

* 注册表：沙箱中会自动生成

  “\HKEY_CURRENT_USER\mySandBox”

  当程序访问注册表时，会拷贝其调用的参数，重命名后放到这个跟键下。

* 网络服务：搭建局域网，让沙箱里的系统访问外网，允许正常数据接收，但是会重定向到指定位置。

* 进程操作：对进程操作来说，当要创建某个不受 信任的进程时，被监控的子进程在还未运行时需要调用 backCallFunc 函数，返回参数 ID 号，通过对比审计进程表 ID 号，如果匹配成功，需要对该进程操作进行虚拟重定向。

### Windows API机制

API（Application Programming Interface）

Windows底层提供给应用程序的接口。

**六大类**：文件、网络、注册表、进程、系统、其他

恶意代码运行也是调用Windows API函数实现。通过恶意代码运行时调用的API可以分析出其动态行为特征。



### 恶意代码常见API

恶意代码对API的调用顺序和传参是的表现会不同于正常程序。

恶意代码的动态行为分析和特征提取主要依赖：API函数名和函数种类。

恶意代码常调用的 API:

* 截屏

  ![image-20210706095448664](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095448664.png)

* 系统信息获取

  ![image-20210706095526492](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095526492.png)

![image-20210706095554541](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095554541.png)

![image-20210706095609958](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095609958.png)

![image-20210706095622215](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095622215.png)

* 自启动

  1、注册表自启动

  ![image-20210706095718693](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095718693.png)

  2、服务自启动

  ![image-20210706095733228](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095733228.png)

* 文件行为

  ![image-20210706095820602](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095820602.png)

* 网络行为

  ![image-20210706095844652](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095844652.png)

* 进程行为

  ![image-20210706095911945](C:\Users\Z&S\AppData\Roaming\Typora\typora-user-images\image-20210706095911945.png)

